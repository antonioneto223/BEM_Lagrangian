    SUBROUTINE LOCAL_COODINATE_SYSTEM(LOCAL_NODE,ELEMENT_S,ROTATION_MATRIX_S,ROTATION_MATRIX_H)
!	
    USE ISOPARAMETRIC_MESH
    USE MATERIALS
	USE CRACKS_DUAL_BEM
	USE SUB_REGIONS_INTERFACES
	USE ANALYSIS
!
    IMPLICIT NONE	
	INTEGER::I,J,K,LOCAL_NODE,NODE_S,ELEMENT_S,NEN	
	REAL*8::VALUES[ALLOCATABLE](:,:),VJAC(3),DVJAC(3,2),JAC,ROTATION_MATRIX_S(3,3),ROTATION_MATRIX_H(3,3)
	REAL*8::ETAX(3),ETAY(3),ETAY_AUX(3),ETAZ(3),COSTHETA,SOMA1,SOMA2
!
    NEN=ELEM_TYPE(ELEMENT_S)*ORDER_ELEM(ELEMENT_S)+(ELEM_TYPE(ELEMENT_S)-3)*(ORDER_ELEM(ELEMENT_S)-1)*POL_FAMILY(ELEMENT_S)	
    ALLOCATE(VALUES(NEN,3))	
!    
    DO K=1,NEN
        VALUES(K,1)=COORD_NODES(NODES_CONNECTIVITY(ELEMENT_S,K),1)
		VALUES(K,2)=COORD_NODES(NODES_CONNECTIVITY(ELEMENT_S,K),2)
		VALUES(K,3)=COORD_NODES(NODES_CONNECTIVITY(ELEMENT_S,K),3)
	ENDDO
!	
	CALL NORMAL_OUTWARD(NEN,VALUES,QSI(ELEMENT_S,LOCAL_NODE,1),QSI(ELEMENT_S,LOCAL_NODE,2),ETAX,VJAC,DVJAC,JAC)
!	
    IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,LOCAL_NODE)).NE.1.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,LOCAL_NODE)).NE.3)THEN
        DO I=1,NEN
            IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,I)).EQ.1)THEN
                LOCAL_NODE=I
            ENDIF
        ENDDO
    ENDIF		
!	               
    SELECT CASE(NEN)
    CASE(3)

                     
    CASE(4)
        SELECT CASE(LOCAL_NODE)
        CASE(1)
            IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.3)THEN   
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)   

                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(1,3)                                                        
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.1)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(1,3)                             
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.1)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(1,3)                            
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(1,3) 
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.1)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)  
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(1,3)                  
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.1)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(1,3)                                      
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.3)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)  
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(1,3)                  
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.3)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(1,3)                                       
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.3)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)  
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(1,3)                                                  
            ELSE
                ETAZ(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAZ(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAZ(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAY_AUX(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAY_AUX(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)                 
            ENDIF                                                                  
        CASE(2)          
            IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.3.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)  
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)                                                
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.1.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)                             
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.1.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.0)THEN
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)                               
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3) 
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.1.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)                      
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.1.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.0)THEN
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)                                  
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.3.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)                      
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.3.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.0)THEN
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)                  
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.3.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.0)THEN
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)                                                                           
            ELSE
                ETAZ(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(2,1)
                ETAZ(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(2,2)
                ETAZ(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(2,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(2,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(2,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(2,3)                 
            ENDIF         
        CASE(3)
            IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.3)THEN
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)                                                                                 
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.1)THEN
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)                                
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.1)THEN
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)  
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)                                
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.1)THEN
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)                      
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.1)THEN
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)                                                    
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.3)THEN
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)                      
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.3)THEN
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)                    
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,4)).EQ.3)THEN
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)                                                                              
            ELSE
                ETAZ(1)=-0.5D0*VALUES(2,1)+0.5D0*VALUES(3,1)
                ETAZ(2)=-0.5D0*VALUES(2,2)+0.5D0*VALUES(3,2)
                ETAZ(3)=-0.5D0*VALUES(2,3)+0.5D0*VALUES(3,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(3,1)
                ETAY_AUX(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(3,2)
                ETAY_AUX(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(3,3)                    
            ENDIF          
        CASE(4)
            IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.3.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)                                                                        
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.1.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)                           
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.1.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.0)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)   
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)                          
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.0)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.1.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.0)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)                       
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.1.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)                                
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.3.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.2.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.0)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3) 
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)                       
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.3.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.2)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)               
            ELSE IF(CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,1)).EQ.3.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,2)).EQ.0.AND.CRACK_TIP(COLLOCPOINTS_CONNECTIVITY(ELEMENT_S,3)).EQ.0)THEN
                ETAZ(1)=-0.5D0*VALUES(4,1)+0.5D0*VALUES(1,1)
                ETAZ(2)=-0.5D0*VALUES(4,2)+0.5D0*VALUES(1,2)
                ETAZ(3)=-0.5D0*VALUES(4,3)+0.5D0*VALUES(1,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)                                                                           
            ELSE
                ETAZ(1)=-0.5D0*VALUES(3,1)+0.5D0*VALUES(4,1)
                ETAZ(2)=-0.5D0*VALUES(3,2)+0.5D0*VALUES(4,2)
                ETAZ(3)=-0.5D0*VALUES(3,3)+0.5D0*VALUES(4,3)
!
                ETAY_AUX(1)=-0.5D0*VALUES(1,1)+0.5D0*VALUES(4,1)
                ETAY_AUX(2)=-0.5D0*VALUES(1,2)+0.5D0*VALUES(4,2)
                ETAY_AUX(3)=-0.5D0*VALUES(1,3)+0.5D0*VALUES(4,3)                 
            ENDIF          
        ENDSELECT
    ENDSELECT
!
    SOMA1=DSQRT(ETAZ(1)**2+ETAZ(2)**2+ETAZ(3)**2) 
    SOMA2=DSQRT(ETAY_AUX(1)**2+ETAY_AUX(2)**2+ETAY_AUX(3)**2)  
    IF(SOMA1.LE.1.D-10)THEN
        ETAY=ETAY_AUX/DSQRT(ETAY_AUX(1)**2+ETAY_AUX(2)**2+ETAY_AUX(3)**2)
        
        ETAZ(1)=ETAX(2)*ETAY(3)-ETAX(3)*ETAY(2) 
        ETAZ(2)=ETAX(3)*ETAY(1)-ETAX(1)*ETAY(3)
        ETAZ(3)=ETAX(1)*ETAY(2)-ETAX(2)*ETAY(1)      
    ELSE IF(SOMA2.LE.1.D-10)THEN 
        ETAZ=ETAZ/DSQRT(ETAZ(1)**2+ETAZ(2)**2+ETAZ(3)**2)
        
        ETAY(1)=ETAX(2)*ETAZ(3)-ETAX(3)*ETAZ(2) 
        ETAY(2)=ETAX(3)*ETAZ(1)-ETAX(1)*ETAZ(3)
        ETAY(3)=ETAX(1)*ETAZ(2)-ETAX(2)*ETAZ(1)
    ELSE            
        ETAZ=ETAZ/DSQRT(ETAZ(1)**2+ETAZ(2)**2+ETAZ(3)**2)                                 
        ETAY_AUX=ETAY_AUX/DSQRT(ETAY_AUX(1)**2+ETAY_AUX(2)**2+ETAY_AUX(3)**2)  
          
        ETAY(1)=ETAX(2)*ETAZ(3)-ETAX(3)*ETAZ(2) 
        ETAY(2)=ETAX(3)*ETAZ(1)-ETAX(1)*ETAZ(3)
        ETAY(3)=ETAX(1)*ETAZ(2)-ETAX(2)*ETAZ(1)
        COSTHETA=ETAY_AUX(1)*ETAY(1)+ETAY_AUX(2)*ETAY(2)+ETAY_AUX(3)*ETAY(3)
        IF(COSTHETA.LT.0.D0)THEN
            ETAY=-ETAY
        ENDIF   
    ENDIF                                    
!
    ROTATION_MATRIX_S(1,1)=ETAX(1)
    ROTATION_MATRIX_S(1,2)=ETAX(2)
    ROTATION_MATRIX_S(1,3)=ETAX(3)
    ROTATION_MATRIX_S(2,1)=ETAY(1)
    ROTATION_MATRIX_S(2,2)=ETAY(2)
    ROTATION_MATRIX_S(2,3)=ETAY(3)    
    ROTATION_MATRIX_S(3,1)=ETAZ(1)
    ROTATION_MATRIX_S(3,2)=ETAZ(2)
    ROTATION_MATRIX_S(3,3)=ETAZ(3) 
!
    ROTATION_MATRIX_H(1,1)=-ETAX(1)
    ROTATION_MATRIX_H(1,2)=-ETAX(2)
    ROTATION_MATRIX_H(1,3)=-ETAX(3)
    ROTATION_MATRIX_H(2,1)=-ETAY(1)
    ROTATION_MATRIX_H(2,2)=-ETAY(2)
    ROTATION_MATRIX_H(2,3)=-ETAY(3)    
    ROTATION_MATRIX_H(3,1)=ETAZ(1)
    ROTATION_MATRIX_H(3,2)=ETAZ(2)
    ROTATION_MATRIX_H(3,3)=ETAZ(3)     
!    
    END SUBROUTINE LOCAL_COODINATE_SYSTEM		